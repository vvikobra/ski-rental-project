<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Ski Rental Notifications</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f4f9; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h2 { text-align: center; color: #333; }
        #status { text-align: center; margin-bottom: 20px; font-weight: bold; color: #dc3545; }
        .notification { padding: 15px; margin-bottom: 10px; border-left: 5px solid; border-radius: 4px; animation: slideIn 0.5s ease-out; background-color: #f8f9fa; border-color: #6c757d; }
        
        .type-BOOKING_CREATED { border-color: #007bff; background-color: #e7f1ff; }
        .type-PAYMENT_CALCULATED { border-color: #ffc107; background-color: #fff3cd; }
        .type-BOOKING_PAID { border-color: #28a745; background-color: #d4edda; }
        .type-SKIPASS_ACTIVATED { border-color: #17a2b8; background-color: #d1ecf1; }
        .type-SKIPASS_USED { border-color: #6610f2; background-color: #e0cffc; }

        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .timestamp { font-size: 0.8em; color: #666; float: right; }
    </style>
</head>
<body>
<div class="container">
    <h2>Ski Rental Notification Center</h2>
    <div id="status">Disconnected</div>
    <div id="notifications-area"></div>
</div>

<script>
    const statusDiv = document.getElementById('status');
    const area = document.getElementById('notifications-area');
    let socket;

    function connect() {
        socket = new WebSocket('ws://localhost:8083/ws/notifications');

        socket.onopen = () => {
            statusDiv.innerText = 'Connected to Notification System';
            statusDiv.style.color = '#28a745';
        };

        socket.onmessage = (event) => {
            const data = JSON.parse(event.data);
            console.log("Received event:", data);
            showNotification(data);
        };

        socket.onclose = () => {
            statusDiv.innerText = 'Connection lost. Reconnecting...';
            statusDiv.style.color = '#dc3545';
            setTimeout(connect, 3000);
        };
    }

    function showNotification(data) {
        const div = document.createElement('div');
        div.className = `notification type-${data.type}`;
        
        let content = '';
        const p = data.payload;
        const time = new Date().toLocaleTimeString();

        switch(data.type) {
            case 'BOOKING_CREATED':
                content = `
                    <strong>Booking Created</strong><span class="timestamp">${time}</span><br>
                    ID: ${p.bookingId}<br>
                    Equipment: ${p.equipmentTypes ? p.equipmentTypes.join(', ') : 'None'}<br>
                    Cost: ${p.totalCost}
                `;
                break;
            case 'PAYMENT_CALCULATED':
                content = `
                    <strong>Payment Calculated</strong><span class="timestamp">${time}</span><br>
                    Amount Due: ${p.finalPrice}
                `;
                break;
            case 'BOOKING_PAID':
                content = `
                    <strong>Booking Paid</strong><span class="timestamp">${time}</span><br>
                    Booking ID: ${p.bookingId}<br>
                    Status: Confirmed
                `;
                break;
            case 'SKIPASS_ACTIVATED':
                content = `
                    <strong>Skipass Activated</strong><span class="timestamp">${time}</span><br>
                    ID: ${p.skipassId}<br>
                    Type: ${p.type}<br>
                    Lifts: ${p.totalLifts || 'Unlimited'}
                `;
                break;
            case 'SKIPASS_USED':
                // p.usedAt приходит как массив чисел [2025, 12, 8, 12, 16, 0, 710655000] после Jackson сериализации
                let usedTime;
                if (Array.isArray(p.usedAt)) {
                    usedTime = new Date(p.usedAt[0], p.usedAt[1] - 1, p.usedAt[2], p.usedAt[3], p.usedAt[4], p.usedAt[5]).toLocaleString();
                } else {
                    usedTime = new Date(p.usedAt).toLocaleString();
                }

                content = `
                    <strong>Skipass Used</strong><span class="timestamp">${time}</span><br>
                    ID: ${p.skipassId}<br>
                    Time: ${usedTime}
                `;
                break;
            default:
                content = `<strong>${data.type}</strong><br>${JSON.stringify(p)}`;
        }

        div.innerHTML = content;
        area.prepend(div);
    }

    connect();
</script>
</body>
</html>
